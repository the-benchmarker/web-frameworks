# Nested CI Matrix System Documentation

## Overview

The web-frameworks repository uses a comprehensive three-level nested CI matrix system to test frameworks across multiple dimensions:

1. **Languages**: Different programming languages (Python, JavaScript/Node.js, Java, Go, Ruby, PHP, etc.)
2. **Frameworks**: Multiple web frameworks for each language
3. **Runtime Versions**: Different runtime versions for each language/framework combination

## Architecture

### Matrix Configuration File

The matrix is configured in `.github/matrix-config.yaml`, which defines:

- **Runtime versions** available for each language
- **Default runtime versions** used for basic testing
- **Optimization settings** for managing build time and resources
- **Cache configurations** for dependency caching
- **Framework-specific runtime overrides** for special cases
- **Exclusions** for known incompatible combinations

### Dynamic Matrix Generation

The matrix is dynamically generated by the `ci:matrix` Rake task in `.tasks/ci.rake`. This task:

1. Scans changed files to determine which frameworks to test
2. Loads the matrix configuration
3. Determines which runtime versions to test based on:
   - Branch (main/master branches run full matrix)
   - Pull request status
   - Changed files (selective testing)
4. Generates a JSON matrix for GitHub Actions
5. Applies optimization rules (max jobs, exclusions, etc.)

### GitHub Actions Workflow

The workflow (`.github/workflows/ci.yml`) consists of two jobs:

1. **Matrix Job**: Generates the dynamic matrix
2. **Test Job**: Runs tests for each matrix combination

## Matrix Levels Explained

### Level 1: Languages

Languages are automatically discovered from the repository structure. Each language directory (`python/`, `javascript/`, `go/`, etc.) contains:

- A `config.yaml` defining language-specific settings
- Multiple framework subdirectories

### Level 2: Frameworks

Frameworks are subdirectories within each language directory. Each framework has:

- A `config.yaml` defining framework-specific settings
- Source code and configuration files
- One or more engines/servers (e.g., uvicorn, gunicorn for Python)

### Level 3: Runtime Versions

Runtime versions are defined in `.github/matrix-config.yaml` under the `runtimes` section. The system intelligently selects which versions to test based on:

- **Full matrix mode**: Triggered on main/master branches or when runtime files change
- **Selective mode**: Triggered on pull requests, tests only default runtime unless runtime-specific files are modified

## Optimization Features

### 1. Selective Testing

Enabled by default in the `optimization` section:

```yaml
optimization:
  selective_testing: true
  pr_default_runtime_only: true
```

**How it works:**
- On PRs: Tests only the default runtime version for each language
- On main/master: Tests all runtime versions
- When runtime files change: Tests all runtime versions for affected languages

### 2. Runtime Trigger Paths

Specific file patterns that trigger full runtime testing:

```yaml
runtime_trigger_paths:
  python:
    - "python/*/Dockerfile"
    - "python/config.yaml"
```

**Usage:**
- If a PR changes `python/django/Dockerfile`, all Python runtime versions are tested
- If a PR only changes `python/django/views.py`, only the default Python runtime is tested

### 3. Maximum Parallel Jobs

Limits the total number of matrix jobs:

```yaml
max_parallel_jobs: 256
```

This prevents overwhelming GitHub Actions runners while still providing comprehensive testing.

### 4. Dependency Caching

Language-specific cache paths are defined:

```yaml
cache:
  enabled: true
  cache_paths:
    python:
      - ~/.cache/pip
    javascript:
      node:
        - ~/.npm
```

GitHub Actions automatically caches these paths to speed up builds.

## Adding New Languages

To add a new language to the matrix system:

### 1. Add Runtime Versions

Edit `.github/matrix-config.yaml`:

```yaml
runtimes:
  newlang:
    - "1.0"
    - "1.1"
    - "2.0"

default_runtimes:
  newlang: "2.0"
```

### 2. Add Cache Configuration

```yaml
cache:
  cache_paths:
    newlang:
      - ~/.newlang/cache
```

### 3. Add Runtime Setup (Optional)

If GitHub Actions has a setup action for your language, add it to `.github/workflows/ci.yml`:

```yaml
- name: Setup NewLang
  if: matrix.language == 'newlang' && matrix.runtime
  uses: actions/setup-newlang@v1
  with:
    version: ${{ matrix.runtime }}
```

### 4. Create Language Directory

Create the language directory structure:

```
newlang/
├── config.yaml          # Language-level configuration
├── framework1/
│   ├── config.yaml      # Framework-level configuration
│   └── ...
└── framework2/
    ├── config.yaml
    └── ...
```

## Adding New Frameworks

To add a new framework within an existing language:

### 1. Create Framework Directory

```bash
mkdir -p <language>/<framework>
cd <language>/<framework>
```

### 2. Create Framework Configuration

Create `config.yaml`:

```yaml
framework:
  website: example.com
  version: 1.0
  engines:
    - engine1
    - engine2
```

### 3. Add Framework Files

Add your framework implementation files according to the language's `files` pattern in its `config.yaml`.

### 4. Test Locally

```bash
bundle exec rake config
export FRAMEWORK=<language>/<framework>
make -f $FRAMEWORK/.Makefile build
```

## Adding Runtime Versions

To add new runtime versions for an existing language:

### 1. Update Matrix Configuration

Edit `.github/matrix-config.yaml`:

```yaml
runtimes:
  python:
    - "3.9"
    - "3.10"
    - "3.11"
    - "3.12"
    - "3.13"  # Add new version
    - "3.14"  # Add another new version
```

### 2. Update Default (Optional)

If the new version should be the default:

```yaml
default_runtimes:
  python: "3.14"
```

### 3. Test the Configuration

The new versions will automatically be included in the next full matrix run (on main/master branches).

## Framework Runtime Overrides

Some frameworks may only work with specific runtime versions. To configure this:

```yaml
framework_runtime_overrides:
  python/legacy-framework:
    - "3.9"
    - "3.10"
  # This framework will only test with Python 3.9 and 3.10
```

## Excluding Incompatible Combinations

If a specific combination is known to be incompatible:

```yaml
exclusions:
  - language: python
    framework: old-framework
    runtime: "3.13"
  # python/old-framework will not be tested with Python 3.13
```

You can also exclude by engine:

```yaml
exclusions:
  - language: python
    framework: async-framework
    engine: gunicorn
    runtime: "3.12"
```

## Monitoring and Reporting

### Matrix Size

The matrix generation task outputs the total number of combinations:

```bash
bundle exec rake ci:matrix
```

### View Matrix Locally

To see what combinations would be tested:

```bash
export FILES='["python/fastapi/config.yaml"]'
bundle exec rake ci:matrix | jq
```

### CI Build Times

Monitor the GitHub Actions workflow runs to track:
- Total build time
- Individual job times
- Success/failure rates per combination

## Best Practices

### 1. Start with Default Runtime

When developing a new framework, focus on the default runtime first:
- It will be tested on every PR
- It represents the recommended version

### 2. Use Selective Testing

Don't force full matrix runs on every PR:
- Only change runtime trigger files when necessary
- Use descriptive commit messages

### 3. Test Locally First

Before pushing, test your framework locally:

```bash
bundle exec rake config
export FRAMEWORK=<language>/<framework>
make -f $FRAMEWORK/.Makefile build
bundle exec rspec .spec
```

### 4. Document Runtime Requirements

If your framework has specific runtime requirements, document them in:
- Framework README
- `framework_runtime_overrides` in matrix-config.yaml

### 5. Monitor CI Resources

Keep an eye on:
- Total matrix size (should stay under max_parallel_jobs)
- Build times
- Cache hit rates

## Troubleshooting

### Matrix Too Large

If the matrix exceeds 256 jobs:

1. Check `max_parallel_jobs` setting
2. Review `pr_default_runtime_only` setting
3. Consider adding exclusions for unsupported combinations

### Runtime Not Testing

If a runtime version isn't being tested:

1. Check it's defined in `runtimes` section
2. Verify no exclusions apply
3. Check if selective testing is limiting tests
4. Review runtime trigger paths

### Cache Not Working

If dependencies aren't being cached:

1. Verify cache paths are correct in matrix-config.yaml
2. Check GitHub Actions setup step uses `cache: true`
3. Review cache key generation

### Build Failures

If builds fail for specific runtime versions:

1. Check Dockerfile supports the runtime version
2. Verify dependencies are compatible
3. Consider adding to exclusions if incompatible
4. Review framework configuration

## Advanced Configuration

### Custom Matrix for Specific Branches

You can customize the matrix behavior per branch by modifying the `full_matrix_branches` list:

```yaml
optimization:
  full_matrix_branches:
    - main
    - master
    - release/*
```

### Language-Specific Optimization

Some languages may need special handling. This can be added to the `ci:matrix` task in `.tasks/ci.rake`.

### Conditional Runtime Testing

For fine-grained control, modify the `get_runtime_versions` method in `.tasks/ci.rake`.

## FAQ

**Q: Why does my PR only test one runtime version?**
A: By default, PRs test only the default runtime for efficiency. Change runtime-specific files to trigger full testing.

**Q: How do I force full runtime testing on a PR?**
A: Modify a file matching a runtime trigger path, or update `.github/matrix-config.yaml`.

**Q: Can I test multiple engine versions per runtime?**
A: Yes, each engine is tested separately. The matrix includes all combinations of framework/engine/runtime.

**Q: What's the maximum number of matrix jobs?**
A: Default is 256, configurable via `max_parallel_jobs`.

**Q: How do I disable runtime versioning for a language?**
A: Don't add the language to the `runtimes` section in matrix-config.yaml.

## Contributing

When contributing changes to the matrix system:

1. Test changes locally first
2. Document new features in this file
3. Update matrix-config.yaml with clear comments
4. Consider backward compatibility
5. Monitor CI impact after merging

## Support

For questions or issues with the matrix system:

1. Check this documentation first
2. Review `.github/matrix-config.yaml` comments
3. Examine `.tasks/ci.rake` code
4. Open an issue with:
   - What you're trying to achieve
   - Current behavior vs expected behavior
   - Relevant configuration snippets
